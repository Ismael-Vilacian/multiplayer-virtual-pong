<html>

<head>
    <meta charset="utf-8">
    <title>Virtual pong</title>

    <link rel="stylesheet" type="text/css" href="index.css" media="screen" />
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div class="home">
        <div class="home_logo">
            <img src="./assets/img/logo.svg" alt="logo">
        </div>

        <div class="home_nickname">
            <div class="input-default">
                <div>Nickname</div>
                <input id="nickname" type="text">
            </div>

            <button class="home_action button-default">Start</button>
        </div>
    </div>

    <div class="game">
        <div class="game_logo">
            <img width="132px" src="./assets/img/logo.svg" alt="logo">
        </div>

        <div class="game_score">
            <div class="game_score-p1">
                <div id="name_player-1"></div>
                <div id="score_player-1"></div>
            </div>
            <div class="game_score-p2">
                <div id="score_player-2"></div>
                <div id="name_player-2"></div>
            </div>
        </div>

        <div class="game_container-tab">
            <canvas id="table" width="742px" height="500px"></canvas>
        </div>
    </div>

    <div class="waiting-queue">
        <h4>Fila de Espera</h4>
        <ul id="queue-list">
            </ul>
    </div>

    <div id="game-transition-overlay" class="game-transition" style="display: none;">
        <div class="transition-content">
            <h2>Novo Desafiante!</h2>
            <p><span id="new-player-name"></span> entra no jogo.</p>
            <div id="countdown-timer" class="countdown">5</div>
        </div>
    </div>

    <script type="module">
        import gameBuilder from './gameBuilder.js';
        import renderScreen from './render-screen.js';
        import createKeyboardController from './keyboard-controller.js';

        const game = gameBuilder();
        const socket = io();

        const queueList = document.getElementById('queue-list');
        const transitionOverlay = document.getElementById('game-transition-overlay');
        const newPlayerNameSpan = document.getElementById('new-player-name');
        const countdownTimerDiv = document.getElementById('countdown-timer');
        const scoreP1El = document.getElementById('score_player-1');
        const scoreP2El = document.getElementById('score_player-2');
        const nameP1El = document.getElementById('name_player-1');
        const nameP2El = document.getElementById('name_player-2');
        
        function updatePlayersAndQueueUI(data) {
            if (!data) return;

            if (data.score && scoreP1El && scoreP2El) {
                scoreP1El.textContent = data.score[1] || 0;
                scoreP2El.textContent = data.score[2] || 0;
            }

            if (data.players && nameP1El && nameP2El) {
                nameP1El.textContent = '';
                nameP2El.textContent = '';
                for (const playerId in data.players) {
                    const player = data.players[playerId];
                    const nameEl = document.getElementById(`name_player-${player.order}`);
                    if (nameEl) {
                        nameEl.textContent = player.nickname;
                    }
                }
            }
            
            if (data.queue && queueList) {
                queueList.innerHTML = '';
                data.queue.forEach(player => {
                    const li = document.createElement('li');
                    li.textContent = player.nickname;
                    queueList.appendChild(li);
                });
            }
        }
        
        const buttonStart = document.querySelector('.home_action');
        buttonStart.addEventListener('click', () => {
            document.querySelector('.home').style.display = 'none';
            document.querySelector('.game').style.display = 'block';

            const nickname = document.querySelector('#nickname');
            socket.emit('playerInfo', { nickname: nickname.value });

            const screen = document.getElementById('table');
            renderScreen(screen, game, requestAnimationFrame, socket.id);
        });

        const keyboardListener = createKeyboardController(document);
        
        keyboardListener.subscribe(game.movePlayer);
        
        keyboardListener.subscribe((command) => {
            socket.emit('move-player', command);
        });

        socket.on('setup', (state) => {
            game.setState(state);
            keyboardListener.registerPlayerId(socket.id);
            updatePlayersAndQueueUI(state);
        });

        socket.on('update-players-and-queue', (data) => {
            if (data.players) game.state.players = data.players;
            if (data.queue) game.state.queue = data.queue;
            if (data.score) game.state.score = data.score;
            updatePlayersAndQueueUI(data);
        });

        socket.on('update-game-transition', (data) => {
            if (!data || !data.transition) return;
            game.state.transition = data.transition;

            if (data.transition.active) {
                newPlayerNameSpan.textContent = data.transition.newPlayerNickname || 'O prÃ³ximo';
                countdownTimerDiv.textContent = data.transition.countdown;
                transitionOverlay.style.display = 'flex';
            } else {
                transitionOverlay.style.display = 'none';
            }
        });
        
        socket.on('update-score', (data) => {
            if (data.score) {
                game.state.score = data.score;
                scoreP1El.textContent = data.score[1] || 0;
                scoreP2El.textContent = data.score[2] || 0;
            }
        });
        
        socket.on('move-ball', (data) => {
            if (data.ball) game.state.ball = data.ball;
        });
        
        socket.on('move-player', (command) => {
            if (socket.id !== command.playerId) {
                game.movePlayer(command);
            }
        });
    </script>
</body>

</html>